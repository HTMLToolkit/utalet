import{a as M,d as C,e as w,n as L}from"./index.js";const E=[{reg:/[あかさたなはまやらわがざだばぱぁゃゎアカサタナハマヤラワガザダバパァャヮ]$/,symbol:"a"},{reg:/[いきしちにひみゐりぎじぢびぴぃイキシチニヒミヰリギジヂビピィ]$/,symbol:"i"},{reg:/[うくすつぬふむゆるぅゅぐずづぶぷウクスツヌフムユルゥグズヅブプヴゥュ]$/,symbol:"u"},{reg:/[えけせてねへめゑれぇげぜでべぺエケセテネヘメヱレェゲゼデベペ]$/,symbol:"e"},{reg:/[おこそとのほもよろをごぞどぼぽぉょオコソトノホモヨロヲゴゾドボポォョ]$/,symbol:"o"},{reg:/ん$/,symbol:"n"}];class F extends M{name="phonemizer.JPPresampPhonemizer";getOtoRecord(e,r,a,i,s,t,o=!1){const p=e.presamp!==void 0?e.presamp.CVRegex:/^([^ぁ-んァ-ヶ]*)([ぁ-んァ-ヶ]+)([^ ]*)$/;if(i==="")return null;const f=a.prev?a.prev.lyric:"",m=p.exec(f),c=m?m[3]:"";if(i==="R"){if(!e.presamp||e.presamp.endingType==="none"||e.presamp.endingType==="final"||r==="-")return null;const v=e.presamp.vowels.find(S=>S.symbol===r).representative,h=e.presamp.alias.endingRest.replace(/%v%/g,r).replace(/%V%/g,v).replace(/%VCPAD%/g,e.presamp.alias.vcPad).replace(/%VCVPAD%/g,e.presamp.alias.vcvPad),N=e.getOtoRecord(h+c,s,t);if(N)return N;const V=e.getOtoRecord(h,s,t);return V||null}if(i.includes("!"))return e.getOtoRecord(i.replace("!",""),s,t);const l=p.exec(i);if(!l&&!o)return e.getOtoRecord(i,s,t);const n=o?i:l[2],d=o?"":l[3],u=i.includes("?"),x=e.getSuffix(s,t),y=e.getSuffix(a.prev?a.prev.notenum:s,a.prev?a.prev.voiceColor:t),R=this.getNextConsonant(a,e);if(R&&a.prev!==null&&a.prev!==void 0&&a.prev.lyric!=="R"&&d+t+x!==c+a.prev?.voiceColor+y&&this.getOtoRecord(e,this.getLastPhoneme(a.prev,e),a.prev,R.symbol,a.prev.notenum,a.prev.voiceColor?a.prev.voiceColor:"",!0)!==null){const v=e.getOtoRecord((u?"?":"")+n+d,s,t);if(v)return v;const h=e.getOtoRecord((u?"?":"")+n,s,t);if(h)return h}if(e.presamp&&!e.presamp.priority.includes(n)){const g=e.getOtoRecord((u?"?":"")+r+" "+n+d,s,t);if(g)return g;const v=e.getOtoRecord((u?"?":"")+r+" "+n,s,t);if(v)return v}if(r!=="-"){const g=e.getOtoRecord((u?"?":"")+"* "+n+d,s,t);if(g)return g;const v=e.getOtoRecord((u?"?":"")+"* "+n,s,t);if(v)return v}const P=e.getOtoRecord((u?"?":"")+n+d,s,t);if(P)return P;const O=e.getOtoRecord((u?"?":"")+n,s,t);return O||e.getOtoRecord(i,s,t)}_applyOto(e,r){if(e.lyric===void 0)throw new Error("lyric is not initial.");if(e.notenum===void 0)throw new Error("notenum is not initial.");const a=e.prev!==void 0?e.prev.phonemizer.getLastPhoneme(e.prev,r):"-",i=this.getOtoRecord(r,a,e,e.lyric,e.notenum,e.voiceColor?e.voiceColor:"");i===null?(e.oto=void 0,e.otoPreutter=0,e.otoOverlap=0,e.atAlias="R",e.atFilename=""):(e.oto=i,e.otoPreutter=i.pre,e.otoOverlap=i.overlap,e.atAlias=i.alias!==""?i.alias:e.lyric,e.atFilename=i.dirpath+(i.dirpath!==""?"/":"")+i.filename)}_autoFitParam(e){const r=e.velocityRate;if(e.prev===void 0){e.atPreutter=e.preutter!==void 0?e.preutter*r:e.otoPreutter!==void 0?e.otoPreutter*r:void 0,e.atOverlap=e.overlap!==void 0?e.overlap*r:e.otoOverlap!==void 0?e.otoOverlap*r:void 0,e.atStp=e.stp!==void 0?e.stp:0;return}if(e.prev.length===void 0)throw new Error("prev length is not initial.");if(e.prev.tempo===void 0)throw new Error("prev tempo is not initial.");if(e.prev.lyric===void 0)throw new Error("prev lyric is not initial.");const a=e.prev.phonemizer.getLastLength(e.prev)*(e.prev.lyric==="R"?1:.5),i=(e.preutter!==void 0?e.preutter:e.otoPreutter)*r,s=(e.overlap!==void 0?e.overlap:e.otoOverlap)*r,t=e.stp!==void 0?e.stp:0;Number.isNaN(i)||Number.isNaN(s)||(a<i-s?(e.atPreutter=i/(i-s)*a,e.atOverlap=s/(i-s)*a,e.atStp=i-e.atPreutter+t):(e.atPreutter=i,e.atOverlap=s,e.atStp=t)),e.prev.lyric!=="R"&&e.atOverlap>=20&&(e.prev.envelope===void 0&&e.prev.setEnvelope(C.envelope),e.envelope===void 0&&e.setEnvelope(C.envelope),e.prev.envelope.point[2]=e.atOverlap,e.prev.envelope.value[2]=100,e.prev.envelope.point[3]=0,e.prev.envelope.value[3]=0,e.envelope.point[1]=e.atOverlap,e.envelope.value[1]=100,e.envelope.point[0]=0,e.envelope.value[0]=0)}_getLastPhoneme(e,r){if(!e)return"-";const a=r.presamp!==void 0?r.presamp.CVRegex:/^([^ぁ-んァ-ヶ]*)([ぁ-んァ-ヶ]+)([^ ]*)$/,i=r.presamp!==void 0?r.presamp.vowelRegs:E,s=a.exec(e.lyric);if(!s)return"-";const t=i.find(o=>o.reg.test(s[2]));return t?t.symbol:"-"}_getLastLength(e){return e.msLength}getNextConsonant(e,r){if(!e||r.presamp===void 0)return null;const a=r.presamp.VCVRegExp,i=r.presamp.CVRegex;if(a.exec(e.lyric)||e.oto&&a.exec(e.oto.alias))return null;const t=i.exec(e.lyric);if(!t)return null;const o=t[2];for(const p of r.presamp.consonants)if(p.CVs.includes(o))return p;return null}getNextPriority(e,r){if(!e||r.presamp===void 0)return!1;const a=r.presamp.VCVRegExp,i=r.presamp.CVRegex;if(a.exec(e.lyric))return!1;const t=i.exec(e.lyric);if(!t)return!1;const o=t[2];return r.presamp.priority.includes(o)}_getNotesCount(e,r){const a=this.getNextConsonant(r.next,e);return this.getOtoRecord(e,this.getLastPhoneme(r,e),r,a?a.symbol:"",r.notenum,r.voiceColor?r.voiceColor:"",!0)!==null?2:1}_getRequestParamm(e,r,a,i){r.oto===void 0?r.applyOto(e):r.autoFitParam();const s=this.getNextConsonant(r.next,e),t=this.getOtoRecord(e,this.getLastPhoneme(r,e),r,s?s.symbol:"",r.notenum,r.voiceColor?r.voiceColor:"",!0),o=[{resamp:void 0,append:void 0}];let p=r.outputMs,f=r.envelope?r.envelope:i.envelope;const m=r.getRenderPitch();if(t!==null){const c=this.getVCTargetLength(r,t,s),l=this.vcAutoFitParam(r,t,c);if(c<=r.targetLength-(r.oto?.velocity??0)||this.getNextPriority(r.next,e)){o.push({resamp:void 0,append:void 0});const n=(r.atPreutter?r.atPreutter:0)+(r.atStp?r.atStp:0),d=r.msLength-c,u=l.preutter+l.stp,x=Math.floor((-n+d-u)/1e3/r.pitchSpan),y=m.slice(x);o[1].resamp={inputWav:t.dirpath!==""?t.dirpath+"/"+t.filename:t.filename,targetTone:L(r.notenum),velocity:100,flags:r.flags!==null&&r.flags!==void 0&&r.flags!==""?r.flags:a,offsetMs:Math.max(0,t.offset),targetMs:Math.ceil((c+l.preutter)/50)*50,fixedMs:t.velocity,cutoffMs:t.blank,intensity:r.intensity!==void 0&&r.intensity!==null&&!Number.isNaN(r.intensity)?r.intensity:i.intensity,modulation:r.modulation!==void 0&&r.modulation!==null&&!Number.isNaN(r.modulation)?r.modulation:i.modulation,tempo:`!${r.tempo.toFixed(2)}`,pitches:w(y)},o[1].append={stp:l.stp,length:c+l.preutter,envelope:{point:[0,l.overlap,s.crossfade?c:10,0],value:[0,100,100,0]},overlap:l.overlap},p=p-c-l.preutter+l.overlap,s.crossfade&&(f.point[1]=c),f.point[2]=l.overlap,f.point[3]=0,f.value[2]=100,f.value[3]=0}}return r.oto!==void 0&&!r.direct&&(o[0].resamp={inputWav:r.oto.dirpath!==""?r.oto.dirpath+"/"+r.oto.filename:r.oto.filename,targetTone:L(r.notenum),velocity:r.velocity!==void 0&&r.velocity!==null&&!Number.isNaN(r.velocity)?r.velocity:i.velocity,flags:r.flags!==null&&r.flags!==void 0&&r.flags!==""?r.flags:a,offsetMs:Math.max(0,r.oto.offset),targetMs:r.targetLength,fixedMs:r.oto.velocity,cutoffMs:r.oto.blank,intensity:r.intensity!==void 0&&r.intensity!==null&&!Number.isNaN(r.intensity)?r.intensity:i.intensity,modulation:r.modulation!==void 0&&r.modulation!==null&&!Number.isNaN(r.modulation)?r.modulation:i.modulation,tempo:`!${r.tempo.toFixed(2)}`,pitches:w(m)}),r.oto!==void 0&&r.direct?o[0].append={inputWav:r.oto.dirpath!==""?r.oto.dirpath+"/"+r.oto.filename:r.oto.filename,stp:r.atStp+r.oto.offset,length:p,envelope:f,overlap:r.atOverlap}:r.oto!==void 0?o[0].append={stp:r.atStp,length:p,envelope:f,overlap:r.atOverlap}:o[0].append={stp:0,length:p,envelope:{point:[0,0],value:[]},overlap:0},o}getVCTargetLength(e,r,a){return a.useCVLength?e.next&&e.next.oto&&e.next.oto.overlap<0?e.next.oto.pre-e.next.oto.overlap:e.next&&e.next.oto?e.next.oto.pre:60:r.blank<0?r.blank*-1-r.pre:e.next&&e.next.oto&&e.next.oto.overlap<0?e.next.oto.pre-e.next.oto.overlap:e.next&&e.next.oto?e.next.oto.pre:60}vcAutoFitParam(e,r,a){const i=e.msLength-a,s=r.pre,t=r.overlap,o=0,p={preutter:0,overlap:0,stp:0};return Number.isNaN(s)||Number.isNaN(t)||(i<s-t?(p.preutter=s/(s-t)*i,p.overlap=t/(s-t)*i,p.stp=s-p.preutter+o):(p.preutter=s,p.overlap=t,p.stp=o)),p.overlap=p.preutter,p}}export{F as JPPresampPhonemizer};
