import{a as P,d as y,e as m,n as V}from"./index.js";const g=/^([^ぁ-んァ-ヶ]*)([ぁ-んァ-ヶ]+)([^ ]*)$/,x=/[-aiuron] ([ぁ-んァ-ヶ]+)/,O=/[あかさたなはまやらわがざだばぱぁゃゎアカサタナハマヤラワガザダバパァャヮ]$/,R=/[いきしちにひみゐりぎじぢびぴぃイキシチニヒミヰリギジヂビピィ]$/,w=/[うくすつぬふむゆるぅゅぐずづぶぷウクスツヌフムユルゥグズヅブプヴゥュ]$/,C=/[えけせてねへめゑれぇげぜでべぺエケセテネヘメヱレェゲゼデベペ]$/,L=/[おこそとのほもよろをごぞどぼぽぉょオコソトノホモヨロヲゴゾドボポォョ]$/,M=/ん$/,S=[{consonant:"k",cvs:["k","か","く","け","こ"],type:"stretch",lengthValue:100,crossfade:!1},{consonant:"ky",cvs:["ky","きゃ","き","きゅ","きぇ","きょ"],type:"stretch",lengthValue:130,crossfade:!1},{consonant:"s",cvs:["s","さ","すぃ","す","せ","そ"],type:"preutter",lengthValue:150,crossfade:!0},{consonant:"sh",cvs:["sh","しゃ","し","しゅ","しぇ","しょ"],type:"preutter",lengthValue:200,crossfade:!0},{consonant:"t",cvs:["t","た","とぅ","て","と"],type:"stretch",lengthValue:100,crossfade:!1},{consonant:"ty",cvs:["ty","てゃ","てぃ","てゅ","てぇ","てょ"],type:"stretch",lengthValue:75,crossfade:!1},{consonant:"ch",cvs:["ch","ちゃ","ち","ちゅ","ちぇ","ちょ"],type:"preutter",lengthValue:150,crossfade:!1},{consonant:"ts",cvs:["ts","つ","つぁ","つぃ","つぇ","つぉ"],type:"preutter",lengthValue:170,crossfade:!1},{consonant:"n",cvs:["n","な","ぬ","ね","の"],type:"preutter",lengthValue:70,crossfade:!0},{consonant:"ny",cvs:["ny","にゃ","に","にゅ","にぇ","にょ"],type:"preutter",lengthValue:70,crossfade:!0},{consonant:"h",cvs:["h","は","へ","ほ"],type:"preutter",lengthValue:110,crossfade:!0},{consonant:"hy",cvs:["hy","ひゃ","ひ","ひゅ","ひぇ","ひょ"],type:"preutter",lengthValue:100,crossfade:!0},{consonant:"f",cvs:["f","ふぁ","ふ","ふぃ","ふぇ","ふぉ"],type:"preutter",lengthValue:130,crossfade:!0},{consonant:"m",cvs:["m","ま","む","め","も"],type:"preutter",lengthValue:75,crossfade:!0},{consonant:"my",cvs:["my","みゃ","み","みゅ","みぇ","みょ"],type:"preutter",lengthValue:60,crossfade:!0},{consonant:"y",cvs:["y","や","ゆ","いぇ","よ","いぃ"],type:"preutter",lengthValue:30,crossfade:!0},{consonant:"r",cvs:["r","ら","る","れ","ろ"],type:"preutter",lengthValue:70,crossfade:!0},{consonant:"ry",cvs:["ry","りゃ","り","りゅ","りぇ","りょ"],type:"preutter",lengthValue:70,crossfade:!0},{consonant:"w",cvs:["w","わ","を","うぃ","うぇ","うぉ"],type:"preutter",lengthValue:50,crossfade:!0},{consonant:"g",cvs:["g","が","ぐ","げ","ご"],type:"stretch",lengthValue:80,crossfade:!1},{consonant:"gy",cvs:["gy","ぎゃ","ぎ","ぎゅ","ぎぇ","ぎょ"],type:"stretch",lengthValue:60,crossfade:!1},{consonant:"z",cvs:["z","ざ","ずぃ","ず","ぜ","ぞ"],type:"preutter",lengthValue:80,crossfade:!0},{consonant:"j",cvs:["j","じゃ","じ","じゅ","じぇ","じょ"],type:"preutter",lengthValue:110,crossfade:!0},{consonant:"d",cvs:["d","だ","どぅ","で","ど"],type:"stretch",lengthValue:60,crossfade:!1},{consonant:"dy",cvs:["dy","でゃ","でぃ","でゅ","でぇ","でょ"],type:"stretch",lengthValue:75,crossfade:!1},{consonant:"b",cvs:["b","ば","ぶ","べ","ぼ"],type:"stretch",lengthValue:50,crossfade:!1},{consonant:"by",cvs:["by","びゃ","び","びゅ","びぇ","びょ"],type:"stretch",lengthValue:45,crossfade:!1},{consonant:"p",cvs:["p","ぱ","ぷ","ぺ","ぽ"],type:"stretch",lengthValue:100,crossfade:!1},{consonant:"py",cvs:["py","ぴゃ","ぴ","ぴゅ","ぴぇ","ぴょ"],type:"stretch",lengthValue:100,crossfade:!1},{consonant:"ng",cvs:["ng","ガ","グ","ゲ","ゴ"],type:"preutter",lengthValue:50,crossfade:!0},{consonant:"ngy",cvs:["ngy","ギャ","ギ","ギュ","ギェ","ギョ"],type:"preutter",lengthValue:40,crossfade:!0},{consonant:"v",cvs:["v","ヴぁ","ヴ","ヴぃ","ヴぇ","ヴぉ"],type:"preutter",lengthValue:100,crossfade:!0},{consonant:"・",cvs:["・あ","・い","・う","・え","・お","・ん"],type:"stretch",lengthValue:50,crossfade:!1}];class $ extends P{name="phonemizer.JPAutoPhonemizer";getOtoRecord(e,t,s,r,a,o=!1){if(s==="")return null;if(s.includes("!"))return e.getOtoRecord(s.replace("!",""),r,a);const n=g.exec(s);if(!n&&!o)return e.getOtoRecord(s,r,a);const l=o?s:n[2],c=o?"":n[3],u=s.includes("?"),p=e.getOtoRecord((u?"?":"")+t+" "+l+c,r,a);if(p)return p;const i=e.getOtoRecord((u?"?":"")+t+" "+l,r,a);if(i)return i;if(t!=="-"){const d=e.getOtoRecord((u?"?":"")+"* "+l+c,r,a);if(d)return d;const h=e.getOtoRecord((u?"?":"")+"* "+l,r,a);if(h)return h}const v=e.getOtoRecord((u?"?":"")+l+c,r,a);if(v||v)return v;const f=e.getOtoRecord((u?"?":"")+l,r,a);return f||e.getOtoRecord(s,r,a)}_applyOto(e,t){if(e.lyric===void 0)throw new Error("lyric is not initial.");if(e.notenum===void 0)throw new Error("notenum is not initial.");const s=e.prev!==void 0?e.prev.phonemizer.getLastPhoneme(e.prev,t):"-",r=this.getOtoRecord(t,s,e.lyric,e.notenum,e.voiceColor?e.voiceColor:"");r===null?(e.oto=void 0,e.otoPreutter=0,e.otoOverlap=0,e.atAlias="R",e.atFilename=""):(e.oto=r,e.otoPreutter=r.pre,e.otoOverlap=r.overlap,e.atAlias=r.alias!==""?r.alias:e.lyric,e.atFilename=r.dirpath+(r.dirpath!==""?"/":"")+r.filename)}_autoFitParam(e){const t=e.velocityRate;if(e.prev===void 0){e.atPreutter=e.preutter!==void 0?e.preutter*t:e.otoPreutter!==void 0?e.otoPreutter*t:void 0,e.atOverlap=e.overlap!==void 0?e.overlap*t:e.otoOverlap!==void 0?e.otoOverlap*t:void 0,e.atStp=e.stp!==void 0?e.stp:0;return}if(e.prev.length===void 0)throw new Error("prev length is not initial.");if(e.prev.tempo===void 0)throw new Error("prev tempo is not initial.");if(e.prev.lyric===void 0)throw new Error("prev lyric is not initial.");const s=e.prev.phonemizer.getLastLength(e.prev)*(e.prev.lyric==="R"?1:.5),r=(e.preutter!==void 0?e.preutter:e.otoPreutter)*t,a=(e.overlap!==void 0?e.overlap:e.otoOverlap)*t,o=e.stp!==void 0?e.stp:0;Number.isNaN(r)||Number.isNaN(a)||(s<r-a?(e.atPreutter=r/(r-a)*s,e.atOverlap=a/(r-a)*s,e.atStp=r-e.atPreutter+o):(e.atPreutter=r,e.atOverlap=a,e.atStp=o)),e.prev.lyric!=="R"&&e.atOverlap>=20&&(e.prev.envelope===void 0&&e.prev.setEnvelope(y.envelope),e.envelope===void 0&&e.setEnvelope(y.envelope),e.prev.envelope.point[2]=e.atOverlap,e.prev.envelope.value[2]=100,e.prev.envelope.point[3]=0,e.prev.envelope.value[3]=0,e.envelope.point[1]=e.atOverlap,e.envelope.value[1]=100,e.envelope.point[0]=0,e.envelope.value[0]=0)}_getLastPhoneme(e,t){if(!e)return"-";const s=g.exec(e.lyric);return s?O.test(s[2])?"a":R.test(s[2])?"i":w.test(s[2])?"u":C.test(s[2])?"e":L.test(s[2])?"o":M.test(s[2])?"n":"-":"-"}_getLastLength(e){return e.msLength}getNextConsonant(e){if(!e||x.exec(e.lyric)||e.oto&&x.exec(e.oto.alias))return null;const s=g.exec(e.lyric);if(!s)return null;const r=s[2];for(const a of S)if(a.cvs.includes(r))return a;return null}_getNotesCount(e,t){const s=this.getNextConsonant(t.next);return this.getOtoRecord(e,this.getLastPhoneme(t,e),s?s.consonant:"",t.notenum,t.voiceColor?t.voiceColor:"",!0)!==null?2:1}_getRequestParamm(e,t,s,r){t.oto===void 0?t.applyOto(e):t.autoFitParam();const a=this.getNextConsonant(t.next),o=this.getOtoRecord(e,this.getLastPhoneme(t,e),a?a.consonant:"",t.notenum,t.voiceColor?t.voiceColor:"",!0),n=[{resamp:void 0,append:void 0}];let l=t.outputMs,c=t.envelope?t.envelope:r.envelope;const u=t.getRenderPitch();if(o!==null){const p=this.getVCTargetLength(t,o,a),i=this.vcAutoFitParam(t,o,p);if(p<=t.targetLength-(t.oto?.velocity??0)){n.push({resamp:void 0,append:void 0});const v=(t.atPreutter?t.atPreutter:0)+(t.atStp?t.atStp:0),f=t.msLength-p,d=i.preutter+i.stp,h=Math.floor((-v+f-d)/1e3/t.pitchSpan),N=u.slice(h);n[1].resamp={inputWav:o.dirpath!==""?o.dirpath+"/"+o.filename:o.filename,targetTone:V(t.notenum),velocity:100,flags:t.flags!==null&&t.flags!==void 0&&t.flags!==""?t.flags:s,offsetMs:Math.max(0,o.offset),targetMs:Math.ceil((p+i.preutter)/50)*50,fixedMs:o.velocity,cutoffMs:o.blank,intensity:t.intensity!==void 0&&t.intensity!==null&&!Number.isNaN(t.intensity)?t.intensity:r.intensity,modulation:t.modulation!==void 0&&t.modulation!==null&&!Number.isNaN(t.modulation)?t.modulation:r.modulation,tempo:`!${t.tempo.toFixed(2)}`,pitches:m(N)},n[1].append={stp:i.stp,length:p+i.preutter,envelope:{point:[0,i.overlap,a.crossfade?p:10,0],value:[0,100,100,0]},overlap:i.overlap},l=l-p-i.preutter+i.overlap,a.crossfade&&(c.point[1]=p),c.point[2]=i.overlap,c.point[3]=0,c.value[2]=100,c.value[3]=0}}return t.oto!==void 0&&!t.direct&&(n[0].resamp={inputWav:t.oto.dirpath!==""?t.oto.dirpath+"/"+t.oto.filename:t.oto.filename,targetTone:V(t.notenum),velocity:t.velocity!==void 0&&t.velocity!==null&&!Number.isNaN(t.velocity)?t.velocity:r.velocity,flags:t.flags!==null&&t.flags!==void 0&&t.flags!==""?t.flags:s,offsetMs:Math.max(0,t.oto.offset),targetMs:t.targetLength,fixedMs:t.oto.velocity,cutoffMs:t.oto.blank,intensity:t.intensity!==void 0&&t.intensity!==null&&!Number.isNaN(t.intensity)?t.intensity:r.intensity,modulation:t.modulation!==void 0&&t.modulation!==null&&!Number.isNaN(t.modulation)?t.modulation:r.modulation,tempo:`!${t.tempo.toFixed(2)}`,pitches:m(u)}),t.oto!==void 0&&t.direct?n[0].append={inputWav:t.oto.dirpath!==""?t.oto.dirpath+"/"+t.oto.filename:t.oto.filename,stp:t.atStp+t.oto.offset,length:l,envelope:c,overlap:t.atOverlap}:t.oto!==void 0?n[0].append={stp:t.atStp,length:l,envelope:c,overlap:t.atOverlap}:n[0].append={stp:0,length:l,envelope:{point:[0,0],value:[]},overlap:0},n}getVCTargetLength(e,t,s){return s.type==="stretch"?t.blank<0?t.blank*-1-t.pre:e.next&&e.next.oto.overlap<0?e.next.oto.pre-e.next.oto.overlap:e.next?e.next.oto.pre:s.lengthValue:s.type==="preutter"?e.next&&e.next.oto.overlap<0?e.next.oto.pre-e.next.oto.overlap:e.next?e.next.oto.pre:s.lengthValue:s.lengthValue}vcAutoFitParam(e,t,s){const r=e.msLength-s,a=t.pre,o=t.overlap,n=0,l={preutter:0,overlap:0,stp:0};return Number.isNaN(a)||Number.isNaN(o)||(r<a-o?(l.preutter=a/(a-o)*r,l.overlap=o/(a-o)*r,l.stp=a-l.preutter+n):(l.preutter=a,l.overlap=o,l.stp=n)),l}}export{$ as JPAutoPhonemizer};
